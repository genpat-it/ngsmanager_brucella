#!/usr/bin/env python3
import sys
from statistics import mean

D={"Chlamydophila_abortus_ompA_target_1":"70","Chlamydophila_abortus_ompA_target_1":"70","Chlamydophila_abortus_ompA_target_2":"71","Chlamydophila_abortus_ompA_target_2":"71","CP006954.1_Bibersteinia_trehalosi_USDA-ARS-USMARC-188_target_1":"73","CP006954.1_Bibersteinia_trehalosi_USDA-ARS-USMARC-188_target_1":"73","CP006954.1_Bibersteinia_trehalosi_USDA-ARS-USMARC-188_target_2":"73","CP006954.1_Bibersteinia_trehalosi_USDA-ARS-USMARC-188_target_2":"73","AM498055.2_Bluetonguevirus_8_NS1_target_2":"197","AM498055.2_Bluetonguevirus_8_NS1_target_2":"197","AM498055.2_Bluetongue_virus_8_NS1_target_1":"105","AM498055.2_Bluetongue_virus_8_NS1_target_1":"105","AM498060.1_Bluetongue_virus_8_NS3_target_1":"75","AM498060.1_Bluetongue_virus_8_NS3_target_1":"75","AM498060.1_Bluetongue_virus_8_NS3_target_2":"106","AM498060.1_Bluetongue_virus_8_NS3_target_2":"106","NC_003679.1_Pestivirus_D_target_1":"123","NC_003679.1_Pestivirus_D_target_1":"123","NC_003679.1_Pestivirus_D_target_2":"90","NC_003679.1_Pestivirus_D_target_2":"90","NC_003679.1_Pestivirus_D_target_3":"104","NC_003679.1_Pestivirus_D_target_3":"104","NC_001876.1_Bovine_mastadenovirus_B_target_1":"79","NC_001876.1_Bovine_mastadenovirus_B_target_1":"79","NC_001876.1_Bovine_mastadenovirus_B_target_2":"81","NC_001876.1_Bovine_mastadenovirus_B_target_2":"81","NC_001876.1_Bovine_mastadenovirus_B_target_3":"85","NC_001876.1_Bovine_mastadenovirus_B_target_3":"85","NC_001876.1_Bovine_mastadenovirus_B_target_4":"76","NC_001876.1_Bovine_mastadenovirus_B_target_4":"76","NC_001876.1_Bovine_mastadenovirus_B_target_5":"74","NC_001876.1_Bovine_mastadenovirus_B_target_5":"74","NC_001876.1_Bovine_mastadenovirus_B_target_6":"83","NC_001876.1_Bovine_mastadenovirus_B_target_6":"83","AC_000191.1_Bovine_mastadenovirus_A_target_1":"77","AC_000191.1_Bovine_mastadenovirus_A_target_1":"77","AC_000191.1_Bovine_mastadenovirus_A_target_2":"72","AC_000191.1_Bovine_mastadenovirus_A_target_2":"72","NC_003045.1_Bovine_coronavirus_target_1":"72","NC_003045.1_Bovine_coronavirus_target_1":"72","NC_003045.1_Bovine_coronavirus_target_2":"57","NC_003045.1_Bovine_coronavirus_target_2":"57","NC_001847.1_Bovine_herpesvirus_1_target_1":"72","NC_001847.1_Bovine_herpesvirus_1_target_1":"72","NC_001847.1_Bovine_herpesvirus_1_target_2":"120","NC_001847.1_Bovine_herpesvirus_1_target_2":"120","NC_001847.1_Bovine_herpesvirus_1_target_3":"77","NC_001847.1_Bovine_herpesvirus_1_target_3":"77","NC_002665.1_Bovine_herpesvirus_4_target1":"64","NC_002665.1_Bovine_herpesvirus_4_target1":"64","NC_002665.1_Bovine_herpesvirus_4_target_2":"76","NC_002665.1_Bovine_herpesvirus_4_target_2":"76","NC_005261.3_Bovine_herpesvirus_5_target_1":"87","NC_005261.3_Bovine_herpesvirus_5_target_1":"87","NC_005261.3_Bovine_herpesvirus_5_target_2":"82","NC_005261.3_Bovine_herpesvirus_5_target_2":"82","NC_005261.3_Bovine_herpesvirus_5_target_3":"86","NC_005261.3_Bovine_herpesvirus_5_target_3":"86","NC_005261.3_Bovine_herpesvirus_5_target_4":"85","NC_005261.3_Bovine_herpesvirus_5_target_4":"85","NC_005261.3_Bovine_herpesvirus_5_target_5":"83","NC_005261.3_Bovine_herpesvirus_5_target_5":"83","NC_005261.3_Bovine_herpesvirus_5_target_6":"85","NC_005261.3_Bovine_herpesvirus_5_target_6":"85","NC_005261.3_Bovine_herpesvirus_5_target_7":"85","NC_005261.3_Bovine_herpesvirus_5_target_7":"85","NC_005261.3_Bovine_herpesvirus_5_target_8":"84","NC_005261.3_Bovine_herpesvirus_5_target_8":"84","NC_005261.3_Bovine_herpesvirus_5_target_9":"81","NC_005261.3_Bovine_herpesvirus_5_target_9":"81","NC_005261.3_Bovine_herpesvirus_5_target_10":"83","NC_005261.3_Bovine_herpesvirus_5_target_10":"83","NC_002161.1_Bovine_respirovirus_target_1":"129","NC_002161.1_Bovine_respirovirus_target_1":"129","NC_002161.1_Bovine_respirovirus_target_2":"146","NC_002161.1_Bovine_respirovirus_target_2":"146","NC_038272.1_Bovine_orthopneumovirus_target_1":"50","NC_038272.1_Bovine_orthopneumovirus_target_1":"50","NC_038272.1_Bovine_orthopneumovirus_target_2":"54","NC_038272.1_Bovine_orthopneumovirus_target_2":"54","NC_038272.1_Bovine_orthopneumovirus_target_3":"57","NC_038272.1_Bovine_orthopneumovirus_target_3":"57","NC_038272.1_Bovine_orthopneumovirus_target_4":"52","NC_038272.1_Bovine_orthopneumovirus_target_4":"52","NC_038272.1_Bovine_orthopneumovirus_target_5":"58","NC_038272.1_Bovine_orthopneumovirus_target_5":"58","NC_038272.1_Bovine_orthopneumovirus_target_6":"170","NC_038272.1_Bovine_orthopneumovirus_target_6":"170","NC_038272.1_Bovine_orthopneumovirus_target_7":"91","NC_038272.1_Bovine_orthopneumovirus_target_7":"91","NC_038272.1_Bovine_orthopneumovirus_target_8":"170","NC_038272.1_Bovine_orthopneumovirus_target_8":"170","NC_038272.1_Bovine_orthopneumovirus_target_9":"53","NC_038272.1_Bovine_orthopneumovirus_target_9":"53","NC_038272.1_Bovine_orthopneumovirus_target_10":"55","NC_038272.1_Bovine_orthopneumovirus_target_10":"55","NC_001461.1_Pestivirus_A_target_1":"127","NC_001461.1_Pestivirus_A_target_1":"127","NC_001461.1_Pestivirus_A_target_2":"59","NC_001461.1_Pestivirus_A_target_2":"59","NC_001461.1_Pestivirus_A_target_3":"83","NC_001461.1_Pestivirus_A_target_3":"83","NC_001461.1_Pestivirus_A_target_4":"149","NC_001461.1_Pestivirus_A_target_4":"149","NC_001461.1_Pestivirus_A_target_5":"63","NC_001461.1_Pestivirus_A_target_5":"63","NC_039237.1_Pestivirus_B_target_1":"79","NC_039237.1_Pestivirus_B_target_1":"79","NC_039237.1_Pestivirus_B_target_2":"115","NC_039237.1_Pestivirus_B_target_2":"115","NC_039237.1_Pestivirus_B_target_3":"67","NC_039237.1_Pestivirus_B_target_3":"67","NC_012812.1_Pestivirus_H_target_1":"79","NC_012812.1_Pestivirus_H_target_1":"79","NC_012812.1_Pestivirus_H_target_2":"75","NC_012812.1_Pestivirus_H_target_2":"75","NC_003317.1_Brucella_melitensis_bv.1_16_M_target_1":"79","NC_003317.1_Brucella_melitensis_bv.1_16_M_target_1":"79","NC_003317.1_Brucella_melitensis_bv.1_16M_target_2":"85","NC_003317.1_Brucella_melitensis_bv.1_16M_target_2":"85","AL111168.1_Campylobacter_jejuni_Gyrase_A_target_1":"71","AL111168.1_Campylobacter_jejuni_Gyrase_A_target_1":"71","AL111168.1_Campylobacter_jejuni_Gyrase_A_target_2":"64","AL111168.1_Campylobacter_jejuni_Gyrase_A_target_2":"64","AL111168.1_Campylobacter_jejuni_MAPA_target_1":"58","AL111168.1_Campylobacter_jejuni_MAPA_target_1":"58","AL111168.1_Campylobacter_jejuni_MAPA_target_2":"66","AL111168.1_Campylobacter_jejuni_MAPA_target_2":"66","MG989243.1_Caprine_alphaherpesvirus_1_JSHA1405_target_1":"84","MG989243.1_Caprine_alphaherpesvirus_1_JSHA1405_target_1":"84","MG989243.1_Caprine_alphaherpesvirus_1_JSHA1405_target_2_":"85","MG989243.1_Caprine_alphaherpesvirus_1_JSHA1405_target_2_":"85","CP002586.1_Chlamydia_psittaci_6BC_target_1":"68","CP002586.1_Chlamydia_psittaci_6BC_target_1":"68","CP002586.1_Chmalydia_psittaci_6BC_target_2":"71","CP002586.1_Chmalydia_psittaci_6BC_target_2":"71","CP032542.1_Coxiella_burnetii_IS1111_target_1":"71","CP032542.1_Coxiella_burnetii_IS1111_target_1":"71","CP032542.1_Coxiella_burnetii_IS1111_target_2":"85","CP032542.1_Coxiella_burnetii_IS1111_target_2":"85","CP018804.1_Histophilus_somni_target_new":"730","CP018804.1_Histophilus_somni_target_new":"730","NC_036615.1_Influenza_D_virus_segment_2_PB1_target_1":"70","NC_036615.1_Influenza_D_virus_segment_2_PB1_target_1":"70","NC_036615.1_Influenza_D_virus_segment_2_PB1_target_2":"79","NC_036615.1_Influenza_D_virus_segment_2_PB1_target_2":"79","CP020414.2_Leptospira_interrogans_LipL32_target_1":"92","CP020414.2_Leptospira_interrogans_LipL32_target_1":"92","CP020414.2_Leptospira_interrogans_LipL32_target_2":"80","CP020414.2_Leptospira_interrogans_LipL32_target_2":"80","CP009577.1_Listeria_ivanovii_smcL_target_1_":"73","CP009577.1_Listeria_ivanovii_smcL_target_1_":"73","CP009577.1_Listeria_ivanovii_smcL_target_2":"57","CP009577.1_Listeria_ivanovii_smcL_target_2":"57","CP023861.1_Listeria_monocytogenes_clpC_ATPase_target_1":"72","CP023861.1_Listeria_monocytogenes_clpC_ATPase_target_1":"72","CP023861.1_Listeria_monocytogenes_clpC_ATPase_target_2":"63","CP023861.1_Listeria_monocytogenes_clpC_ATPase_target_2":"63","CP023861.1_Listeria_monocytogenes_flaA_target_1":"70","CP023861.1_Listeria_monocytogenes_flaA_target_1":"70","CP023861.1_Listeria_monocytogenes_flaA_target_2":"70","CP023861.1_Listeria_monocytogenes_flaA_target_2":"70","CP023861.1_Listeria_monocytogenes_InlA_target_1_":"58","CP023861.1_Listeria_monocytogenes_InlA_target_1_":"58","CP023861.1_Listeria_monocytogenes_InlA_target_2_":"71","CP023861.1_Listeria_monocytogenes_InlA_target_2_":"71","CP023044.1_Mannheimia_hamelolytica_strain_191_target_1":"75","CP023044.1_Mannheimia_hamelolytica_strain_191_target_1":"75","CP023044.1_Mannheimia_hamelolytica_strain_191_target_2":"56","CP023044.1_Mannheimia_hamelolytica_strain_191_target_2":"56","EF436233.1_Moraxella_bovisCal1_cytotoxin_(mbxA)_target_1":"66","EF436233.1_Moraxella_bovisCal1_cytotoxin_(mbxA)_target_1":"66","EF436233.1_Moraxella_bovisCal1_cytotoxin_(mbxA)_target_2":"67","EF436233.1_Moraxella_bovisCal1_cytotoxin_(mbxA)_target_2":"67","NZ_LAUS01000003.1_Mycoplasma_bovis_target_1":"64","NZ_LAUS01000003.1_Mycoplasma_bovis_target_1":"64","NZ_LAUS01000003.1_Mycoplasma_bovis_target_2":"63","NZ_LAUS01000003.1_Mycoplasma_bovis_target_2":"63","MK790054.1_Neospora_caninum_NC5_target_":"80","MK790054.1_Neospora_caninum_NC5_target_":"80","CP028926.1_Pasteurella_multocida_kmt1_target_1":"68","CP028926.1_Pasteurella_multocida_kmt1_target_1":"68","CP028926.1_Pasteurella_multocida_kmt1_target_2":"82","CP028926.1_Pasteurella_multocida_kmt1_target_2":"82","AE006468.2_Salmonella_enterica_FljB_target_1":"81","AE006468.2_Salmonella_enterica_FljB_target_1":"81","AE006468.2_Salmonella_enterica_FljB_target_2":"78","AE006468.2_Salmonella_enterica_FljB_target_2":"78","KC355458.1_Schmallenberg_virus_F6_Segment_M_target_2":"67","KC355458.1_Schmallenberg_virus_F6_Segment_M_target_2":"67","XM_002367716.1_Toxoplasma_gondii_Rop18_target_1":"76","XM_002367716.1_Toxoplasma_gondii_Rop18_target_1":"76","XM_002367716.1_Toxoplasma_gondii_Rop18_target_2":"70","XM_002367716.1_Toxoplasma_gondii_Rop18_target_2":"70","LC500001.1_Trueperella_pyogenes_pyolysin_target_1":"66","LC500001.1_Trueperella_pyogenes_pyolysin_target_1":"66","LC500001.1_Trueperella_pyogenes_pyolysin_target_2":"74","LC500001.1_Trueperella_pyogenes_pyolysin_target_2":"74"}


def create_coverage_report(sample, ds, samtools_depth_output, file_result):
    d_file = open(samtools_depth_output, "r")
    # get [min, max] vcov
    dizmatch = {}
    for line in d_file.readlines():
        split_line = line.strip().split("\t")
        match = split_line[0]
        if match in D.keys():
            if len(split_line) > 2:
                if match not in dizmatch.keys():
                    dizmatch[match] = [split_line[1],[int(split_line[2])]]
                else:
                    dizmatch[match][0] = int(split_line[1])
                    dizmatch[match][1].append(int(split_line[2]))
                    [split_line[1],[split_line[2]]]
        else:
            break
    result = open(file_result, 'w')
    result.write("CMP_ID,SAMPLE_DS,TARGET_NAME,%_HCOV,MEAN_VCOV\n")
    for target in dizmatch.keys():
        result.write("{},{},{},{},{}\n".format(sample, ds.replace("DS", ""), target, str((dizmatch[target][0]/int(D[target]))*100), str(mean(dizmatch[target][1]))))
    result.close()
    d_file.close()


if __name__ == "__main__":
    if len(sys.argv) < 5:
        sys.stderr.write(
            "Usage: %s <sample> <ds> <samtools_view_out> <samtools_depth_out> <import_file_result>" % (sys.argv[0]))
        sys.exit(1)
    else:
        create_coverage_report(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4])
